<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Gameweek Recommendations Tool</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;
        const { TrendingUp, RefreshCw, Users, Target, DollarSign, AlertCircle, Upload, Code } = lucide;

        const FPLAnalyzer = () => {
          const [loading, setLoading] = useState(false);
          const [players, setPlayers] = useState([]);
          const [teams, setTeams] = useState({});
          const [fixtures, setFixtures] = useState([]);
          const [recommendations, setRecommendations] = useState(null);
          const [error, setError] = useState(null);
          const [currentGameweek, setCurrentGameweek] = useState(null);
          const [showManualInput, setShowManualInput] = useState(false);
          const [manualData, setManualData] = useState('');

          const corsProxies = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/'
          ];

          const fetchFPLData = async () => {
            setLoading(true);
            setError(null);
            
            for (let i = 0; i < corsProxies.length; i++) {
              try {
                const proxy = corsProxies[i];
                console.log(`Trying proxy ${i + 1}/${corsProxies.length}: ${proxy}`);
                
                const response = await fetch(proxy + encodeURIComponent('https://fantasy.premierleague.com/api/bootstrap-static/'));
                
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const teamsMap = {};
                data.teams.forEach(team => {
                  teamsMap[team.id] = team;
                });
                
                setTeams(teamsMap);
                setPlayers(data.elements);
                
                const currentGW = data.events.find(gw => gw.is_current);
                setCurrentGameweek(currentGW ? currentGW.id : null);
                
                const fixturesResponse = await fetch(proxy + encodeURIComponent('https://fantasy.premierleague.com/api/fixtures/'));
                
                if (!fixturesResponse.ok) {
                  throw new Error(`HTTP error! status: ${fixturesResponse.status}`);
                }
                
                const fixturesData = await fixturesResponse.json();
                setFixtures(fixturesData);
                
                analyzeData(data.elements, teamsMap, fixturesData, currentGW ? currentGW.id : null);
                setLoading(false);
                return;
                
              } catch (err) {
                console.error(`Proxy ${i + 1} failed:`, err);
                if (i === corsProxies.length - 1) {
                  setError(
                    `All API fetch methods failed. Please use the manual data input option below.`
                  );
                }
              }
            }
            
            setLoading(false);
          };

          const handleManualDataSubmit = () => {
            try {
              setLoading(true);
              setError(null);
              
              const data = JSON.parse(manualData);
              
              if (!data.elements || !data.teams || !data.events) {
                throw new Error('Invalid data format. Please paste the complete bootstrap-static API response.');
              }
              
              const teamsMap = {};
              data.teams.forEach(team => {
                teamsMap[team.id] = team;
              });
              
              setTeams(teamsMap);
              setPlayers(data.elements);
              
              const currentGW = data.events.find(gw => gw.is_current);
              setCurrentGameweek(currentGW ? currentGW.id : null);
              
              analyzeData(data.elements, teamsMap, [], currentGW ? currentGW.id : null);
              
              setShowManualInput(false);
              setManualData('');
              
            } catch (err) {
              setError(`Error parsing data: ${err.message}`);
            } finally {
              setLoading(false);
            }
          };

          const analyzeData = (playersData, teamsMap, fixturesData, currentGW) => {
            const nextGW = currentGW ? currentGW + 1 : null;
            
            const upcomingFixtures = fixturesData.filter(f => f.event === nextGW);
            
            const calculateFixtureDifficulty = (teamId) => {
              const teamFixtures = upcomingFixtures.filter(
                f => f.team_h === teamId || f.team_a === teamId
              );
              
              if (teamFixtures.length === 0) return 3;
              
              return teamFixtures.reduce((sum, fixture) => {
                const difficulty = fixture.team_h === teamId 
                  ? fixture.team_h_difficulty 
                  : fixture.team_a_difficulty;
                return sum + difficulty;
              }, 0) / teamFixtures.length;
            };
            
            const scoredPlayers = playersData.map(player => {
              const form = parseFloat(player.form) || 0;
              const pointsPerGame = player.minutes > 0 ? player.total_points / player.minutes * 90 : 0;
              const selectedBy = parseFloat(player.selected_by_percent) || 0;
              const valueScore = player.now_cost > 0 ? (player.total_points / player.now_cost) * 10 : 0;
              const fixtureDifficulty = calculateFixtureDifficulty(player.team);
              const fixtureScore = (5 - fixtureDifficulty) * 2;
              
              const score = (
                form * 3 +
                pointsPerGame * 2 +
                valueScore * 2 +
                fixtureScore * 1.5 +
                (player.minutes > 500 ? 5 : 0) +
                (player.ict_index ? parseFloat(player.ict_index) / 20 : 0)
              );
              
              return {
                ...player,
                score,
                form,
                fixtureDifficulty,
                valueScore
              };
            });
            
            const availablePlayers = scoredPlayers.filter(p => 
              p.status === 'a' && (p.chance_of_playing_next_round === null || p.chance_of_playing_next_round >= 75)
            );
            
            const byPosition = {
              1: availablePlayers.filter(p => p.element_type === 1).sort((a, b) => b.score - a.score).slice(0, 10),
              2: availablePlayers.filter(p => p.element_type === 2).sort((a, b) => b.score - a.score).slice(0, 15),
              3: availablePlayers.filter(p => p.element_type === 3).sort((a, b) => b.score - a.score).slice(0, 15),
              4: availablePlayers.filter(p => p.element_type === 4).sort((a, b) => b.score - a.score).slice(0, 15)
            };
            
            const captainPicks = availablePlayers
              .sort((a, b) => b.score - a.score)
              .slice(0, 5);
            
            const differentials = availablePlayers
              .filter(p => parseFloat(p.selected_by_percent) < 5 && p.score > 10)
              .sort((a, b) => b.score - a.score)
              .slice(0, 10);
            
            setRecommendations({
              byPosition,
              captainPicks,
              differentials,
              nextGameweek: nextGW
            });
          };

          const getPositionName = (elementType) => {
            const positions = { 1: 'Goalkeeper', 2: 'Defender', 3: 'Midfielder', 4: 'Forward' };
            return positions[elementType];
          };

          const formatPrice = (price) => {
            return `Â£${(price / 10).toFixed(1)}m`;
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900 p-4">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-2xl p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h1 className="text-3xl font-bold text-purple-900 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                        FPL Gameweek Recommendations
                      </h1>
                      <p className="text-gray-600 mt-1">Data-driven insights for your Fantasy Premier League team</p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={fetchFPLData}
                        disabled={loading}
                        className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={loading ? 'animate-spin' : ''}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        {loading ? 'Loading...' : 'Auto Fetch'}
                      </button>
                      <button
                        onClick={() => setShowManualInput(!showManualInput)}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Manual Input
                      </button>
                    </div>
                  </div>
                  
                  {showManualInput && (
                    <div className="bg-indigo-50 rounded-lg p-4 mb-4">
                      <h3 className="font-semibold text-indigo-900 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                        Manual Data Input
                      </h3>
                      <p className="text-sm text-gray-700 mb-3">
                        1. Visit: <a href="https://fantasy.premierleague.com/api/bootstrap-static/" target="_blank" rel="noopener noreferrer" className="text-indigo-600 underline">https://fantasy.premierleague.com/api/bootstrap-static/</a>
                        <br />
                        2. Copy all the JSON data from that page
                        <br />
                        3. Paste it in the box below and click "Analyze Data"
                      </p>
                      <textarea
                        value={manualData}
                        onChange={(e) => setManualData(e.target.value)}
                        placeholder="Paste the complete JSON data here..."
                        className="w-full h-32 p-3 border border-gray-300 rounded-lg font-mono text-sm mb-3"
                      />
                      <button
                        onClick={handleManualDataSubmit}
                        disabled={!manualData.trim() || loading}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        Analyze Data
                      </button>
                    </div>
                  )}
                  
                  {currentGameweek && (
                    <div className="bg-purple-50 rounded-lg p-4 mb-4">
                      <p className="text-purple-900 font-semibold">
                        Current Gameweek: {currentGameweek} | Next Gameweek: {currentGameweek + 1}
                      </p>
                    </div>
                  )}
                  
                  {error && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-2 text-red-800">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                      <div>
                        <p className="font-semibold">Error</p>
                        <p className="text-sm">{error}</p>
                      </div>
                    </div>
                  )}
                </div>

                {recommendations && (
                  <>
                    <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                        Top Captain Picks (GW {recommendations.nextGameweek})
                      </h2>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        {recommendations.captainPicks.map((player, idx) => (
                          <div key={player.id} className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border-2 border-yellow-400">
                            <div className="text-2xl font-bold text-yellow-700 mb-1">#{idx + 1}</div>
                            <div className="font-bold text-gray-900">{player.web_name}</div>
                            <div className="text-sm text-gray-600">{teams[player.team]?.short_name}</div>
                            <div className="text-sm text-gray-600">{getPositionName(player.element_type)}</div>
                            <div className="mt-2 space-y-1 text-xs">
                              <div className="flex justify-between">
                                <span className="text-gray-600">Form:</span>
                                <span className="font-semibold">{player.form}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Price:</span>
                                <span className="font-semibold">{formatPrice(player.now_cost)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Points:</span>
                                <span className="font-semibold">{player.total_points}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Top Picks by Position
                      </h2>
                      
                      {[1, 2, 3, 4].map(position => (
                        <div key={position} className="mb-6 last:mb-0">
                          <h3 className="text-xl font-semibold text-purple-700 mb-3">
                            {getPositionName(position)}s
                          </h3>
                          <div className="overflow-x-auto">
                            <table className="w-full">
                              <thead className="bg-purple-50">
                                <tr>
                                  <th className="px-4 py-2 text-left text-sm font-semibold text-purple-900">Player</th>
                                  <th className="px-4 py-2 text-left text-sm font-semibold text-purple-900">Team</th>
                                  <th className="px-4 py-2 text-center text-sm font-semibold text-purple-900">Price</th>
                                  <th className="px-4 py-2 text-center text-sm font-semibold text-purple-900">Form</th>
                                  <th className="px-4 py-2 text-center text-sm font-semibold text-purple-900">Points</th>
                                  <th className="px-4 py-2 text-center text-sm font-semibold text-purple-900">Selected %</th>
                                  <th className="px-4 py-2 text-center text-sm font-semibold text-purple-900">Fixture</th>
                                </tr>
                              </thead>
                              <tbody>
                                {recommendations.byPosition[position].slice(0, 5).map((player, idx) => (
                                  <tr key={player.id} className={idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                    <td className="px-4 py-3 font-medium text-gray-900">{player.web_name}</td>
                                    <td className="px-4 py-3 text-gray-700">{teams[player.team]?.short_name}</td>
                                    <td className="px-4 py-3 text-center">{formatPrice(player.now_cost)}</td>
                                    <td className="px-4 py-3 text-center font-semibold text-green-600">{player.form}</td>
                                    <td className="px-4 py-3 text-center">{player.total_points}</td>
                                    <td className="px-4 py-3 text-center">{player.selected_by_percent}%</td>
                                    <td className="px-4 py-3 text-center">
                                      <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                        player.fixtureDifficulty <= 2 ? 'bg-green-100 text-green-800' :
                                        player.fixtureDifficulty <= 3 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                      }`}>
                                        {player.fixtureDifficulty.toFixed(1)}
                                      </span>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="bg-white rounded-lg shadow-xl p-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        Differential Picks (Low Ownership)
                      </h2>
                      <p className="text-gray-600 mb-4">Players owned by less than 5% who could be great differentials</p>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        {recommendations.differentials.slice(0, 5).map((player) => (
                          <div key={player.id} className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border-2 border-indigo-300">
                            <div className="font-bold text-gray-900">{player.web_name}</div>
                            <div className="text-sm text-gray-600">{teams[player.team]?.short_name}</div>
                            <div className="text-sm text-gray-600">{getPositionName(player.element_type)}</div>
                            <div className="mt-2 space-y-1 text-xs">
                              <div className="flex justify-between">
                                <span className="text-gray-600">Price:</span>
                                <span className="font-semibold">{formatPrice(player.now_cost)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Form:</span>
                                <span className="font-semibold">{player.form}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Owned:</span>
                                <span className="font-semibold text-indigo-600">{player.selected_by_percent}%</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </>
                )}

                {!recommendations && !loading && (
                  <div className="bg-white rounded-lg shadow-xl p-12 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-300 mx-auto mb-4"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    <h3 className="text-xl font-semibold text-gray-700 mb-2">Ready to analyze FPL data</h3>
                    <p className="text-gray-600 mb-4">Click "Auto Fetch" to try automatic data retrieval, or use "Manual Input" if that doesn't work</p>
                    <div className="bg-gray-50 rounded-lg p-4 text-sm text-left max-w-2xl mx-auto">
                      <p className="font-semibold mb-2">Manual Input Instructions:</p>
                      <ol className="list-decimal list-inside space-y-1 text-gray-700">
                        <li>Click the "Manual Input" button above</li>
                        <li>Visit the FPL API URL in a new tab</li>
                        <li>Copy all the JSON data from that page</li>
                        <li>Paste it into the text box and click "Analyze Data"</li>
                      </ol>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<FPLAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>